<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Anotador de Horas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111">

<style>
body{font-family:Arial;background:#111;color:#fff;padding:15px}
h2{text-align:center}
button{padding:12px;width:100%;font-size:18px;margin-top:10px}
.day{border:1px solid #444;padding:8px;margin:5px 0}
.active{background:#0a7}
.small{font-size:14px;color:#ccc}
</style>
</head>
<body>

<h2 id="mesTitulo"></h2>
<div id="calendario"></div>

<button id="btn">INICIAR</button>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const hoy = new Date();
const año = hoy.getFullYear();
const mes = hoy.getMonth();

const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
"Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

document.getElementById("mesTitulo").innerText =
  meses[mes] + " " + año;

const diasMes = new Date(año, mes + 1, 0).getDate();
const cal = document.getElementById("calendario");

let datos = JSON.parse(localStorage.getItem("horasMes")) || {};
let inicio = localStorage.getItem("inicio");

// Crear calendario
for (let d = 1; d <= diasMes; d++) {
  if (!datos[d]) datos[d] = {normales:0, extra50:0, extra100:0};

  const fecha = new Date(año, mes, d);
  const diaSemana = fecha.getDay();
  const nombreDia = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"][diaSemana];

  const div = document.createElement("div");
  div.className = "day";
  div.id = "d" + d;

  div.innerHTML = `
    <b>${nombreDia} ${d}</b><br>
    <span class="small">Normales: ${datos[d].normales} hs</span><br>
    <span class="small">Extra 50%: ${datos[d].extra50} hs</span><br>
    <span class="small">Extra 100%: ${datos[d].extra100} hs</span>
  `;
  cal.appendChild(div);
}

function actualizarActivo() {
  document.querySelectorAll(".day").forEach(x => x.classList.remove("active"));
  if (inicio) document.getElementById("d" + hoy.getDate()).classList.add("active");
}
actualizarActivo();

// Botón INICIAR / FINALIZAR
document.getElementById("btn").onclick = () => {
  if (!inicio) {
    inicio = Date.now();
    localStorage.setItem("inicio", inicio);
    document.getElementById("btn").innerText = "FINALIZAR";
  } else {
    const fin = new Date();
    let horas = (fin - inicio) / 3600000;
    let red = Math.round(horas * 2) / 2;

    const dia = hoy.getDate();
    const diaSemana = hoy.getDay();
    const horaFin = fin.getHours();

    let normales = 0;
    let extra50 = 0;
    let extra100 = 0;

    if (diaSemana === 0) {
      // Domingo → todo 100%
      extra100 = red;

    } else if (diaSemana >= 1 && diaSemana <= 5) {
      // Lunes a viernes
      let disp = Math.max(0, 8 - datos[dia].normales);
      normales = Math.min(disp, red);
      extra50 = red - normales;

    } else if (diaSemana === 6) {
      // Sábado
      let disp = Math.max(0, 5 - datos[dia].normales);
      normales = Math.min(disp, red);
      let resto = red - normales;

      datos[dia].normales += normales;

      if (horaFin >= 13) {
        extra100 = resto;
      } else {
        extra50 = resto;
      }
    }

    // Guardamos los datos
    datos[dia].normales += normales;
    datos[dia].extra50 += extra50;
    datos[dia].extra100 += extra100;

    localStorage.setItem("horasMes", JSON.stringify(datos));
    localStorage.removeItem("inicio");
    inicio = null;

    // Actualizamos la visualización
    const dDiv = document.getElementById("d" + dia);
    dDiv.innerHTML = `
      <b>${["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"][diaSemana]} ${dia}</b><br>
      <span class="small">Normales: ${datos[dia].normales} hs</span><br>
      <span class="small">Extra 50%: ${datos[dia].extra50} hs</span><br>
      <span class="small">Extra 100%: ${datos[dia].extra100} hs</span>
    `;

    document.getElementById("btn").innerText = "INICIAR";
  }
  actualizarActivo();
};
</script>

</body>
  </html>
